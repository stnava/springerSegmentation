---
title: "Single and multi-subject connectivity methods for scalar MRI"
author: "Brian B. Avants"
date: "`r Sys.Date()`"
output: pdf_document
---

# Abstract

In one or two paragraphs, please write an overview of the method described.

This is a _sample_ book written in **Markdown**. You can use anything that Pandoc's Markdown supports, e.g., a math equation $a^2 + b^2 = c^2$.

**Keywords**: segmentation, convolutional networks, butt, ass Please include 5-10 key words for referencing by electronic databases and search engines.


# Introduction

This section should contain a summary of, and the outline of any theory to, the method that you’re are describing. It should also outline the major procedures involved in the protocol.

# Materials

This section should list all buffers, reagents, solutions, etc., that are necessary for carrying out you’re technique. In particular, please stress any requirements relating to storage conditions and stability of solutions (e.g., light sensitive, make fresh as required, store at 4oC, stable at 4°C for up to 2 months, etc.), purity of reagents, etc. Also indicate any reagents that are particularly toxic, any radiation hazards, or special protection that needs to be observed. Do not list standard laboratory apparatus (e.g., centrifuge). Please try to make any sub-headings to this section match the subheadings used in section 3.

# Methods

This is the main section and should explain in detail the individual steps necessary to carry out the technique. Where possible, please simply list the steps in numerical order. For techniques that comprise a number of separate major procedures, please indicate these separate procedures in the introduction, and then subdivide section 3 into subheadings to cover each procedure. The steps in each subsection should then be numbered individually, renumbering 2 from number one. Do take great care to try to indicate any little "tricks" or nuances that help improve your method by referring to relevant "notes" in section 4 (see below). This sort of information rarely gets into the scientific literature. You may also find it useful to relate to some aspects of the theory in this section indicating the purpose of some of the major steps by crossreferencing to an appropriate “note”. Do not be tempted to get involved in the description of variations/alternatives to your technique in this section: this can be done in the "Notes" section. Stick to the basic procedure detailed in this section.

This section must be comprehensive. Do not send the reader away to find information for a particular step in another reference. All relevant practical detail must be given in this section.


```{r antsrex1}
library( ANTsR )
img = antsImageRead( getANTsRData( "r16" ) )
msk = getMask( img )
r = 5
k = 50
mat = getNeighborhoodInMask( img, msk, rep( r, img@dimension ), boundary.condition = 'mean' )
```

Given a matrix representation of image neighborhood structure, we can express the relationship
between ...

```{r antsrex2}
sdm = sparseDistanceMatrix( scale( mat ), k, kmetric = 'euc' )
glp = sdm
diag( glp ) = 0
glp[ glp != 0 ] = -1
diag( glp ) = abs( rowSums( glp ) )  # this is the graph laplacian
# basic checks
print( sum( glp[ 55 , ] ) )
print( sum( glp[    , 1400 ] ) )
# now evs
nv = 50
vpca = irlba::irlba( glp, nu = nv, nv = nv )
eim = makeImage( msk, rowSums(vpca$v[,1:10] ) )
eim = makeImage( msk, vpca$v[,11] )
plot( img, eim*(-1), window.overlay=c(0.01,0.8) )
```


Allow the image to diffuse along its laplacian.

```{r glapdiff}
# from wikipedia
V = vpca$v
D = vpca$d
C0 = img[ msk == 1]
# Transform the initial condition into the coordinate system of the eigenvectors
C0V = t( V ) %*% C0  
tseq = seq( 0, 0.05, by=0.01 )
for ( t in tseq ) {
# Loop through times and decay each initial component
  Phi = C0V * exp( -D * t ) # Exponential decay for each component
  Phi = V %*% Phi # Transform from eigenvector coordinate system to original coordinate system
  phiImg = makeImage( msk, as.numeric( Phi ) ) * msk
  plot( phiImg )
}
```

# Notes

As we all know, even the simplest techniques go wrong from time to time. Would you therefore indicate any major problems or faults that can occur with your technique? Try to indicate the major sources of problems and how they can be identified and overcome. With reference to related techniques, any variations of the technique that you have described should also be made in this section, as well as--where relevant--an indication of the sensitivity of the method, timescale for the singled technique, etc. This "Notes" section is a hallmark of this series and has been singled out for praise by a number of reviewers. Please try and make this section as extensive as possible by putting on paper all of your various experiences with the technique. Each ‘Note’ should be cross-referenced with the ‘Materials’ and ‘Methods’ sections, e.g. (see Note 1).

Some _significant_ applications are demonstrated in this chapter.

## Example one

## Example two


# Final Words

We have finished a nice book.


`r if (knitr:::is_html_output()) '# References'`

```{r include=FALSE}
# automatically create a bib database for R packages
knitr::write_bib(c(
  .packages(), 'bookdown', 'knitr', 'rmarkdown'
), 'packages.bib')
```
